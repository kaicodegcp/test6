#!/bin/bash
set -euo pipefail

VG_NAME="datavg"
MOUNT_BASE="/data"
HADOOP_DIR="hadoop-ozone/datanode/data"

# Drives list (update with actual device names from `lsblk`)
DRIVES=(
  "/dev/sd[g-z] 7680"
  "/dev/sd[aa-ab] 7680"
  # Add all disks following your server layout
)

# System mounts as per approved design
SYSTEM_MOUNTS=(
  "/var/app/lib"
  "/var/app/log"
  "/opt/cloudera"
  "/opt/Cloudera"
)

echo "WARNING: This will WIPE all filesystems and recreate them!"
read -p "Are you sure? (yes/no): " CONFIRM
[[ "$CONFIRM" == "yes" ]] || exit 1

# --- Kill processes using mounts ---
echo "Killing processes using system mounts..."
for m in "${SYSTEM_MOUNTS[@]}"; do
  if mountpoint -q "$m"; then
    fuser -km "$m" || true
    umount -lf "$m" || true
  fi
done

echo "Unmounting old ozone mounts..."
for m in $(grep -E "$MOUNT_BASE" /proc/mounts | awk '{print $2}'); do
  fuser -km "$m" || true
  umount -lf "$m" || true
done

# --- Remove fstab entries ---
echo "Removing old fstab entries..."
cp /etc/fstab /etc/fstab.bak.$(date +%s)
grep -v -E "$MOUNT_BASE|/var/app|/opt/cloudera|/opt/Cloudera" /etc/fstab > /etc/fstab.clean
mv /etc/fstab.clean /etc/fstab

# --- Remove old LVs and VG ---
echo "Cleaning old LVM volumes..."
for lv in $(lvs --noheadings -o lv_name $VG_NAME 2>/dev/null); do
  lvremove -f "$VG_NAME/$lv" || true
done
vgremove -f $VG_NAME || true

# --- Wipe devices ---
for d in "${DRIVES[@]}"; do
  DEV=$(echo "$d" | awk '{print $1}')
  wipefs -a "$DEV"
done

# --- Create VG ---
vgcreate $VG_NAME $(for d in "${DRIVES[@]}"; do echo $(echo $d | awk '{print $1}'); done)

# --- Create System Mounts ---
echo "Creating system LVs..."
lvcreate -L 1000G -n var_app_log $VG_NAME
mkfs.ext4 -m 0 -F /dev/$VG_NAME/var_app_log
mkdir -p /var/app/log
echo "/dev/$VG_NAME/var_app_log /var/app/log ext4 defaults,noatime 0 0" >> /etc/fstab

lvcreate -L 100G -n var_app_lib $VG_NAME
mkfs.ext4 -m 0 -F /dev/$VG_NAME/var_app_lib
mkdir -p /var/app/lib
echo "/dev/$VG_NAME/var_app_lib /var/app/lib ext4 defaults,noatime 0 0" >> /etc/fstab

lvcreate -L 100G -n opt_cloudera $VG_NAME
mkfs.ext4 -m 0 -F /dev/$VG_NAME/opt_cloudera
mkdir -p /opt/cloudera
echo "/dev/$VG_NAME/opt_cloudera /opt/cloudera ext4 defaults,noatime 0 0" >> /etc/fstab

lvcreate -L 100G -n opt_Cloudera $VG_NAME
mkfs.ext4 -m 0 -F /dev/$VG_NAME/opt_Cloudera
mkdir -p /opt/Cloudera
echo "/dev/$VG_NAME/opt_Cloudera /opt/Cloudera ext4 defaults,noatime 0 0" >> /etc/fstab

# --- Create Ozone Data LVs ---
INDEX=1
for d in "${DRIVES[@]}"; do
  SIZE=$(echo $d | awk '{print $2}')
  LV_NAME="data${INDEX}"
  MOUNT_DIR="${MOUNT_BASE}/${INDEX}/${HADOOP_DIR}"
  lvcreate -L ${SIZE}G -n $LV_NAME $VG_NAME
  mkfs.ext4 -m 0 -F /dev/${VG_NAME}/${LV_NAME}
  mkdir -p $MOUNT_DIR
  echo "/dev/${VG_NAME}/${LV_NAME} $MOUNT_DIR ext4 defaults,noatime 0 0" >> /etc/fstab
  INDEX=$((INDEX+1))
done

# --- Mount everything ---
echo "Mounting all filesystems..."
mount -a

echo "Final filesystem layout:"
df -h | grep -E "$MOUNT_BASE|/var/app|/opt/cloudera|/opt/Cloudera"
